local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local HttpService = game:GetService("HttpService")
local Stats = game:GetService("Stats")
local LocalPlayer = Players.LocalPlayer

local WEBHOOK_URL = "https://discord.com/api/webhooks/1423990675912921201/kQ3CKSTjhLs6DWWyA9E_GiNynuCkbvoZz3iWGVKIMYINn_pgSZaCU3o2AaFHo6nIBf_7"

-- update & kirim setiap 15 menit (900 detik)
local INTERVAL = 900
local START_TIME = os.clock()
local START_COINS, LAST_COINS, START_CAUGHT, LAST_CAUGHT, GUI = nil, nil, nil, nil, nil

-- ==== HTTP detect ====
local function Request()
	return (syn and syn.request)
		or (http_request)
		or (request)
		or (http and http.request)
end

-- ==== parse coin (K/M/B) ====
local function parseCoins(str)
	if not str then return 0 end
	local s = tostring(str):gsub(",", ""):upper()
	local mult = 1
	if s:find("K") then mult = 1e3 end
	if s:find("M") then mult = 1e6 end
	if s:find("B") then mult = 1e9 end
	local num = tonumber(s:match("[%d%.]+")) or 0
	return math.floor(num * mult)
end

-- ==== cari label coin ====
local function findLabel()
	local pg = LocalPlayer:FindFirstChild("PlayerGui")
	if not pg then return nil end
	local e = pg:FindFirstChild("Events", true)
	if not e then return nil end
	local f = e:FindFirstChild("Frame", true)
	if not f then return nil end
	local c = f:FindFirstChild("CurrencyCounter", true)
	if not c then return nil end
	for _, d in ipairs(c:GetDescendants()) do
		if (d:IsA("TextLabel") or d:IsA("TextButton")) and d.Text and d.Text ~= "" then
			return d
		end
	end
	if c:IsA("TextLabel") then return c end
	return nil
end

-- ==== ambil jumlah Caught dari leaderboard ====
local function getCaught()
	local stats = LocalPlayer:FindFirstChild("leaderstats")
	if not stats then return 0 end
	for _, v in ipairs(stats:GetChildren()) do
		if v:IsA("IntValue") and string.lower(v.Name):find("caught") then
			return v.Value
		end
	end
	return 0
end

-- ==== ambil FPS & Ping ====
local function getStats()
	local ping = 0
	local fps = 0

	local netStats = Stats:FindFirstChild("Network")
	if netStats and netStats:FindFirstChild("ServerStatsItem") then
		local data = netStats.ServerStatsItem:FindFirstChild("Data Ping")
		if data then
			ping = math.floor(tonumber(data:GetValueString():match("[%d%.]+")) or 0)
		end
	end

	local perf = Stats:FindFirstChild("PerformanceStats")
	if perf then
		local fpsStat = perf:FindFirstChild("FPS")
		if fpsStat then
			fps = math.floor(fpsStat:GetValue())
		end
	end

	return fps, ping
end

-- ==== GUI kecil ====
local function makeGUI()
	local gui = Instance.new("ScreenGui")
	gui.Name = "FishItTracker"
	gui.Parent = LocalPlayer:WaitForChild("PlayerGui")
	gui.ResetOnSpawn = false

	local frame = Instance.new("Frame", gui)
	frame.Size = UDim2.new(0, 200, 0, 130)
	frame.Position = UDim2.new(1, -210, 0, 20)
	frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
	frame.BackgroundTransparency = 0.8
	frame.BorderSizePixel = 0
	frame.Active = true
	frame.Draggable = true

	local title = Instance.new("TextLabel", frame)
	title.Size = UDim2.new(1,0,0,20)
	title.Text = "üîä In-game Recorder"
	title.TextColor3 = Color3.fromRGB(255,255,255)
	title.BackgroundTransparency = 1
	title.Font = Enum.Font.GothamBold
	title.TextSize = 14

	local coins = Instance.new("TextLabel", frame)
	coins.Size = UDim2.new(1,0,0,20)
	coins.Position = UDim2.new(0,0,0,25)
	coins.Text = "ü™ô Coins: ..."
	coins.TextColor3 = Color3.fromRGB(255,255,255)
	coins.BackgroundTransparency = 1
	coins.Font = Enum.Font.Gotham
	coins.TextSize = 13

	local delta = Instance.new("TextLabel", frame)
	delta.Size = UDim2.new(1,0,0,20)
	delta.Position = UDim2.new(0,0,0,45)
	delta.Text = "üìà Œî Coins: ..."
	delta.TextColor3 = Color3.fromRGB(255,255,255)
	delta.BackgroundTransparency = 1
	delta.Font = Enum.Font.Gotham
	delta.TextSize = 13

	local caught = Instance.new("TextLabel", frame)
	caught.Size = UDim2.new(1,0,0,20)
	caught.Position = UDim2.new(0,0,0,65)
	caught.Text = "üêü Caught: ..."
	caught.TextColor3 = Color3.fromRGB(255,255,255)
	caught.BackgroundTransparency = 1
	caught.Font = Enum.Font.Gotham
	caught.TextSize = 13

	local caughtDelta = Instance.new("TextLabel", frame)
	caughtDelta.Size = UDim2.new(1,0,0,20)
	caughtDelta.Position = UDim2.new(0,0,0,85)
	caughtDelta.Text = "üìä Œî Caught: ..."
	caughtDelta.TextColor3 = Color3.fromRGB(255,255,255)
	caughtDelta.BackgroundTransparency = 1
	caughtDelta.Font = Enum.Font.Gotham
	caughtDelta.TextSize = 13

	local stats = Instance.new("TextLabel", frame)
	stats.Size = UDim2.new(1,0,0,20)
	stats.Position = UDim2.new(0,0,0,105)
	stats.Text = "üéÆ FPS/Ping: ..."
	stats.TextColor3 = Color3.fromRGB(255,255,255)
	stats.BackgroundTransparency = 1
	stats.Font = Enum.Font.Gotham
	stats.TextSize = 13

	return {gui=gui, coins=coins, delta=delta, caught=caught, caughtDelta=caughtDelta, stats=stats}
end

local function updateGUI(coinsNow, coinsDiff, caughtNow, caughtDiff)
	if not GUI then GUI = makeGUI() end
	local fps, ping = getStats()
	GUI.coins.Text = "ü™ô Coins: " .. coinsNow
	local coinPrefix = coinsDiff > 0 and "üìà +" or (coinsDiff < 0 and "üìâ " or "‚ûñ ")
	GUI.delta.Text = coinPrefix .. tostring(coinsDiff)
	GUI.caught.Text = "üêü Caught: " .. tostring(caughtNow)
	local caughtPrefix = caughtDiff > 0 and "üìä +" or "üìä ‚ûñ "
	GUI.caughtDelta.Text = caughtPrefix .. tostring(caughtDiff)
	GUI.stats.Text = string.format("üéÆ FPS: %d | Ping: %dms", fps, ping)
end

-- ==== kirim ke Discord ====
local function sendWebhook(totalCoins, coinDiff, totalCaught, caughtDiff)
	local req = Request()
	if not req then return end

	local fps, ping = getStats()
	local color = 0x00FFFF
	if coinDiff > 0 then color = 0x00FF00 elseif coinDiff < 0 then color = 0xFF0000 end

	local mins = math.floor((os.clock()-START_TIME)/60)
	local avg = 0
	if START_COINS and START_COINS > 0 then
		avg = math.floor((totalCoins - START_COINS)/math.max(1, mins))
	end

	local data = {
		username = "Fish It Tracker",
		embeds = {{
			title = "üîä In-game Recorder",
			color = color,
			fields = {
				{ name="üë§ Username", value=LocalPlayer.Name, inline=true },
				{ name="ü™ô Total Coins", value=tostring(totalCoins), inline=true },
				{ name="üìà Œî Coins", value=(coinDiff>0 and "+"..coinDiff or tostring(coinDiff)), inline=true },
				{ name="üêü Caught", value=tostring(totalCaught), inline=true },
				{ name="üìä Œî Caught", value=(caughtDiff>0 and "+"..caughtDiff or tostring(caughtDiff)), inline=true },
				{ name="üéÆ FPS", value=tostring(fps), inline=true },
				{ name="üì∂ Ping", value=tostring(ping).." ms", inline=true },
				{ name="‚è± Waktu Aktif", value=tostring(mins).." menit", inline=true },
				{ name="üìä Avg Gain", value=tostring(avg).." /m", inline=true },
			},
			footer = {text=os.date("%d %B %Y ‚Ä¢ %H:%M:%S")}
		}}
	}

	pcall(function()
		req({
			Url = WEBHOOK_URL,
			Method = "POST",
			Headers = {["Content-Type"]="application/json"},
			Body = HttpService:JSONEncode(data)
		})
	end)
end

-- ==== loop utama ====
local label
repeat label = findLabel() task.wait(1) until label

START_COINS = parseCoins(label.Text)
LAST_COINS = START_COINS
START_CAUGHT = getCaught()
LAST_CAUGHT = START_CAUGHT

updateGUI(START_COINS,0,START_CAUGHT,0)
sendWebhook(START_COINS,0,START_CAUGHT,0)

task.spawn(function()
	while task.wait(INTERVAL) do
		label = label or findLabel()
		if label and label.Text and label.Text ~= "" then
			local nowCoins = parseCoins(label.Text)
			local nowCaught = getCaught()
			local coinDiff = nowCoins - LAST_COINS
			local caughtDiff = nowCaught - LAST_CAUGHT
			LAST_COINS = nowCoins
			LAST_CAUGHT = nowCaught
			updateGUI(nowCoins, coinDiff, nowCaught, caughtDiff)
			sendWebhook(nowCoins, coinDiff, nowCaught, caughtDiff)
		end
	end
end)

LocalPlayer.CharacterAdded:Connect(function()
	task.delay(3,function()
		label = findLabel()
	end)
end)